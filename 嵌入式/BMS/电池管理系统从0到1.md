# 什么是BMS
**BMS**，全称是 **Battery Management System**，中文叫**电池管理系统**。

你可以把它想象成一个非常尽职尽责、无所不能的 **“电池保姆”** 或 **“电池大脑”**。它的核心任务就是**时刻照顾电池组（通常是锂离子电池）的健康与安全，并让其发挥最佳性能**。

为什么需要这么一个“保姆”呢？因为锂离子电池虽然性能优异，但也很“娇气”：
*   **过充**（充电太多）、**过放**（放电太狠）、**过热**、**过流**（电流太大）都会对其造成不可逆的损伤，甚至引发燃烧、爆炸等严重安全事故。
*   电池本身无法直接告诉我们它还剩多少电（SOC）或者是否老化（SOH）。

而BMS，就是为解决这些问题而生的。

---

### BMS的核心职责（四大功能）

这个“电池保姆”的工作主要分为以下四个方面：

#### 1. 监测 - “眼睛”和“耳朵”
这是BMS最基本的功能，即**实时采集**电池的各项物理参数。
*   **电压监测**：精确测量**每一节电芯**的电压。这是防止过充和过放的第一道防线。
*   **电流监测**：测量流入（充电）和流出（放电）电池组的**总电流**。这是计算电量、判断过流的基础。
*   **温度监测**：在电池组的关键位置安装温度传感器，监测温度。锂电池怕冷又怕热，温度管理至关重要。

> **对你而言**：这部分需要你熟悉**ADC（模数转换）** 原理，以及如何通过**I2C/SPI**等总线与专门的模拟前端（**AFE**）芯片通信来获取这些数据。

#### 2. 保护 - “肌肉”和“反射弧”
基于监测到的数据，BMS需要做出判断，并在危险发生时果断采取行动，就像人的条件反射。
*   **判断**：将测量值与设定的阈值进行比较。
*   **行动**：一旦发现**过压、欠压、过流、短路、超温**等情况，立即控制**继电器**或**MOSFET**（一种电子开关）断开电路，从而保护电池。这是安全性的根本保障。

> **对你而言**：你需要编写逻辑判断代码，并学会控制**GPIO**口来驱动这些开关器件。

#### 3. 估算 - “大脑”
这是BMS技术中的**难点和核心**，体现了系统的智能程度。它需要根据监测到的数据，计算出一些无法直接测量的、至关重要的“状态”。
*   **SOC估算**：**荷电状态**，也就是我们常说的“还剩多少电”。就像燃油车的油表。最常用的方法是**安时积分法**（通过累计电流计算）并结合**电压校正**。
*   **SOH估算**：**健康状态**，反映电池的寿命还剩多少。就像人的健康度。通常通过容量衰减和内阻增大的程度来判断。
*   **SOP估算**：**功率状态**，电池当前能提供或接受多大功率。这决定了电动车能瞬间加速多快或能多快进行能量回收。

> **对你而言**：这将涉及复杂的算法。初期你可能只需要调用现有算法函数，但后期需要深入理解并参与优化这些模型（如卡尔曼滤波）。

#### 4. 均衡 - “理疗师”
由于制造工艺的微小差异，电池组中数百甚至数千节电芯的老化速度不可能完全一致。有的电芯电量多点，有的少点。BMS的均衡功能就是**主动减少电芯之间的这种不一致性**，延长整个电池组的寿命。
*   **被动均衡**：给电量高的电芯并联一个电阻，把多余的电能以热量形式消耗掉。简单、成本低，但浪费能量。
*   **主动均衡**：通过电容或电感等元件，把电量高的电芯的能量转移给电量低的电芯。效率高，但电路复杂，成本高。

> **对你而言**：你需要配置AFE芯片的均衡控制寄存器，并设计合理的均衡策略（何时开启、对哪节电芯均衡）。

#### 5. 通信 - “嘴巴”
BMS不能默默无闻地工作，它需要把电池的所有信息（电压、电流、温度、SOC、SOH、故障码等）**报告给上层设备**（如整车控制器、充电机、仪表盘），同时也能接收指令。
*   **常用通信方式**：**CAN总线**（汽车领域绝对主流）、**UART**（串口，常用于内部调试）、**RS485**等。

> **对你而言**：学习**CAN总线**协议将是你的必修课。你需要编写代码来打包（发送）和解包（解析）CAN报文。

---

### 总结与比喻

为了让概念更清晰，我们做一个有趣的比喻：

| 功能 | 比喻 | 目的 |
| :--- | :--- | :--- |
| **监测** | **护士量体温、测血压** | 收集生命体征数据 |
| **保护** | **医生喊停、紧急抢救** | 在危险时立即中断，保命第一 |
| **估算** | **专家会诊、预测病情** | 判断健康状况和预后（还有多少“日子”） |
| **均衡** | **理疗师做按摩调理** | 让身体各部分机能恢复平衡 |
| **通信** | **病人家属汇报情况** | 与外界保持信息畅通 |

对于你——一名嵌入式软件工程师来说，BMS就是你将要编写程序的那个“大脑”。你的代码将负责：
1.  **驱动硬件**（读取AFE、控制开关）。
2.  **实现逻辑**（判断是否过压过流）。
3.  **运行算法**（计算SOC、SOH）。
4.  **管理通信**（收发CAN报文）。

### 举例说明
如磷酸铁锂的电压是2.5V-3.65V，三元锂（镍钴锰锂）的电压是2.7V-4.25V，这些电池会先进行并联再进行串联，从而增加容量与输出电压、电流。
* 电压：
    * 初始容量：首先需要检测初始容量；
    * 过压/欠压：当电压过压/欠压时需要做保护动作；
    * 均衡：当电压不均衡时需要进行均衡来提高电池使用寿命；
    * SOC：需要使用 SOC 估算初始容量等
* 电流：
    * SOC：电池通过并联提高电流，在充放电过程中对电流进行实时检测，通过按时积分法`当前SOC = 上次SOC + (充电电流 × 时间) / 总容量`等计算 SOC；
    * 过流/短路：当电流超过正常值时需要进行过流保护，当电池短路时瞬间出现非常大的电流需要进行短路保护；
    * 充放电电流：在低温条件下、低SOC等情况，需要对充放电电流进行限制；
    * 内阻：电流会影响内阻大小；
* 温度
    * SOC：充放电过程中会导致温度的变化、环境温度也会有不同，这些都会对SOC产生影响；
    * 热管理：在高温/低温下需要进行热管理，以保证电池的安全；
    * 充放电电流：会导致温度的变化；
    * 内阻：会导致温度的变化；

![图 0](assets/1756883653898.png)  

# SOC 与电压的关系
1. 平台期间的电压采样需要较高精度的采样
    ![图 1](assets/1756946904997.png)  
    * OCV（Open Circuit Voltage，开路电压）设备是用于测试锂电池的开路电压的工具。其工作原理是基于锂电池在开路条件下的电化学特性。
    当锂电池处于开路状态时，没有电流流过电池的外部电路，此时电池内部的化学反应会导致电位差的产生。锂电池的正极和负极之间存在一定的电势差，这就是开路电压。
    OCV测试设备通过将电极针对锂电池的正负极分别连接到测试装置上，在无电流流过的情况下测量电压。这种测试方式消除了电流的影响，使得测量结果准确反映出锂电池在静止状态下的开路电压。在测试过程中，OCV设备会记录下开路电压的数值。通过对锂电池在不同充放电状态下的开路电压进行测试，可以获取锂电池的电压特性曲线。这些数据可以评估锂电池的健康状态、容量和剩余电量等参数，帮助用户了解锂电池的性能和使用情况。
2. 电压的采样会影响SOC的计算
    OCV的测量精度会直接影响初始SOC。磷酸铁锂电压平台非常窄，因此测量OCV是个难点。
3. 在不同温度下，温度会影响SOC与电压的曲线
4. 可利用SOC曲线末端对电池的容量进行标定和修正
    充放电末端电压的变化曲线比较陡峭，可以在此阶段对电池的容量进行标定和修正。

# BMS中电压采样的方法

## 共模电压和差模电压
### 核心比喻：测量“漂浮”在水面上的高度差

想象一下，有两个木块漂浮在一条流动的河流上：
*   **木块A** 高出水面 2 cm。
*   **木块B** 高出水面 5 cm。

**问题：** 木块B比木块A高多少？

**答案：** 很简单，**5cm - 2cm = 3cm**。这个 **3cm** 就是你关心的**有效信号**，也就是两个测量点之间的**差值**。在电学里，这被称为 **差模电压**。

现在，关键来了：整条**河流的水面**正在快速上涨和下跌（比如因为上游开了闸）。也就是说，这两个木块相对于**河岸（大地）** 的高度在剧烈地、同步地变化。

*   水面涨1米，木块A对河岸的高度就是 1m + 2cm，木块B是 1m + 5cm。
*   水面涨10米，木块A对河岸的高度就是 10m + 2cm，木块B是 10m + 5cm。

这个**不断变化的水面高度**，就是 **共模电压**。它是两个测量点**共同拥有**的电压基准。

**你的目标**：你只关心那两个木块的**相对高度差（3cm）**，而完全不想知道现在水面到底有多高（10米？100米？）。这个水面高度（共模电压）对你来说是巨大的、无用的、甚至是有害的“噪声”。

---

### 转换到BMS的真实世界

在BMS中，你要测量第10节电芯的电压（假设是Cell10）。
*   你的测量方式是：测量 **Cell10正极** 和 **Cell10负极** 之间的电位差。
*   在电池包里，Cell10的负极，其实就是Cell9的正极。
*   整个电池包的第1节电芯的负极，才是整个系统的“地”。

所以，当你去测量Cell10时，你相当于站在一个很高的“水面”上（即Cell9的正极电压，可能是 9 * 3.7V ≈ 33.3V）去测量那一点点高度差（3.7V）。

*   **差模电压**：你真正想测的Cell10的电压，例如 **3.7V**。
*   **共模电压**：Cell10负极相对于系统地的电压，也就是下面9节电芯的总电压，例如 **33.3V**。

**你的测量仪器（ADC）面临的最大挑战就是：**
它必须能忽略掉那个巨大的、33.3V的“共模电压”，并极其精确地测量出那个微小的、3.7V的“差模电压”。

---

### 为什么共模电压很讨厌？

1.  **超出测量范围**：大部分普通的ADC和运算放大器的工作电压范围很小（比如0-5V）。你无法用一个0-5V的ADC去测量一个（33.3V + 3.7V）= 37V的信号，它直接就饱和甚至烧毁了。
2.  **精度干扰**：即使ADC能承受高电压，那个巨大的共模电压的任何微小波动，都会淹没掉你想测量的微小差模信号，导致测量结果完全不准。

### BMS是如何解决这个问题的？—— 差分测量与共模抑制比

BMS中的核心芯片——**AFE** 采用了一种非常巧妙的方法：

1.  **差分输入**：AFE的每个电压检测通道都有两个输入端：**V+** 和 **V-**。
    *   V+ 接在Cell10的正极。
    *   V- 接在Cell10的负极。
2.  **内部减法器**：AFE内部电路的核心功能是做减法：`输出电压 = (V+) - (V-)`。
    *   代入我们的例子：`输出电压 = (33.3V + 3.7V) - (33.3V) = 3.7V`。
    *   看到了吗？那个讨厌的共模电压（33.3V）在减法过程中**被完美地抵消掉了**！最后输出的正是我们想要的差模电压（3.7V）。

3.  **共模抑制比**：衡量AFE芯片性能的一个**极其重要**的参数。
    *   **是什么**：它表示芯片抑制共模电压信号、放大差模电压信号的能力。**CMRR值越高，芯片性能越好**。
    *   **比喻**：就像你的助听器能完美屏蔽背景噪音（共模），只清晰放大对话声（差模）。CMRR越高，这个“降噪”能力就越强。

### 总结对你来说的意义

| 概念 | 说明 | 对你的重要性 |
| :--- | :--- | :--- |
| **差模电压** | 你**真正想测量**的信号，即**单节电芯的电压**。 | 你的最终目标，算法依赖的原始数据。 |
| **共模电压** | 测量点相对于系统参考地的**共同电压**，在电池串联中会**累积得非常高**。 | **需要被硬件克服的干扰源**。理解它才能明白为什么BMS需要特殊的AFE芯片。 |
| **CMRR** | 芯片**抑制共模干扰**能力的指标。 | 阅读AFE芯片数据手册时必须要关注的关键参数。值越高，测量越准确。 |

**结论：**
共模电压是BMS硬件设计者必须用电路去解决的核心问题。对于你（嵌入式软件工程师）而言，理解这个概念能让你：
1.  **看懂芯片手册**：明白为什么AFE芯片要强调高CMRR和高压工艺。
2.  **理解系统局限**：知道测量误差的可能来源之一。
3.  **与硬件工程师沟通**：有了共同语言，能更好地理解整个系统的工作原理。

## 单体电压采样的基本原理
![图 2](assets/1757037491742.png)  

## 分立器件采样单体电压
![图 3](assets/1757043528397.png)  
传统方式，通过切换不同的通道得到电池的单体电压，然后输入到ADC里。传统方式采样速率、精度、可靠性这些都较差。

## AFE采样单体电压
![图 4](assets/1757049476181.png)  
